if(typeof EVENTABLE==="undefined"){EVENTABLE=true}var creator=function(){function F(){}F.prototype=this;return new F};var merge=function(obj,configs){var k;obj=obj||{};configs=configs||[];configs.forEach(function(x){if(typeof x==="object"){for(k in x){if(x.hasOwnProperty(k))obj[k]=x[k]}}});return obj};Stativus={DEFAULT_TREE:"default",SUBSTATE_DELIM:"SUBSTATE:",version:"0.9.4"};Stativus.State={isState:true,_data:null,_isNone:function(value){return value===undefined||value===null},goToState:function(name,data){var sc=this.statechart;if(sc){sc.goToState(name,this.globalConcurrentState,this.localConcurrentState,data)}},goToHistoryState:function(name,isRecursive){var sc=this.statechart;if(sc){sc.goToHistoryState(name,this.globalConcurrentState,this.localConcurrentState,isRecursive)}},sendEvent:function(evt){var sc=this.statechart;if(sc){sc.sendEvent.apply(sc,arguments)}},sendAction:function(evt){return this.sendEvent.apply(this,arguments)},getData:function(key){if(this._isNone(key))return key;var sc=this.statechart,ret=this._data[key];if(this._isNone(ret))ret=sc.getData(key,this.parentState,this.globalConcurrentState);return ret},setData:function(key,value){if(this._isNone(key))return value;this._data[key]=value},removeData:function(key){if(this._isNone(key))return key;var sc=this.statechart,ret=this._data[key];if(this._isNone(ret)){sc.removeData(key,this.parentState,this.globalConcurrentState)}else delete this._data[key]},setHistoryState:function(state){this.history=this.substatesAreConcurrent?this.substates:state.name}};Stativus.State.create=function(config,sc){var nState,k,i,len,configs=[config],key=config.name+"_"+config.globalConcurrentState,waitingConfig=sc._configs_in_waiting[key];nState=creator.call(this);nState._data={};if(waitingConfig)configs.push(waitingConfig);return merge(nState,configs)};Stativus.Statechart={create:function(config){var sc=creator.call(this);sc.isStatechart=true;sc._all_states={};sc._all_states[Stativus.DEFAULT_TREE]={};sc._states_with_concurrent_substates={};sc._current_subtrees={};sc._current_state={};sc._current_state[Stativus.DEFAULT_TREE]=null;sc._goToStateLocked=false;sc._sendEventLocked=false;sc._pendingStateTransitions=[];sc._pendingEvents=[];sc._active_subtrees={};sc._configs_in_waiting={};return sc},addState:function(name){var tree,obj,hasConcurrentSubstates=false,pState,pName,states,cTree,nState,config,configs=[],len,i,that=this,key;for(i=1,len=arguments.length;i<len;i++){configs[i-1]=config=arguments[i];hasConcurrentSubstates=hasConcurrentSubstates||!!config.substatesAreConcurrent;tree=tree||config.globalConcurrentState;pName=pName||config.parentState}tree=tree||Stativus.DEFAULT_TREE;config=len===1?{}:merge(null,configs);config.name=name;config.statechart=this;config.globalConcurrentState=tree;cTree=this._states_with_concurrent_substates[tree];if(hasConcurrentSubstates){obj=this._states_with_concurrent_substates[tree]||{};obj[name]=true;this._states_with_concurrent_substates[tree]=obj}if(pName){pState=this._all_states[tree][pName];if(!pState){key=pName+"_"+tree;this._configs_in_waiting[key]=pState=this._configs_in_waiting[key]||{}}pState.substates=pState.substates||[];pState.substates.push(name)}nState=Stativus.State.create(config,this);obj=this._all_states[tree]||{};obj[name]=nState;this._all_states[tree]=obj;nState._beenAdded=true;states=nState.states||[];states.forEach(function(x,idx){var args=[],good=false,last;if(typeof x==="object"&&x.length>0){args=args.concat(x);good=true}else if(typeof x==="string"){args.push(x);good=true}else if(typeof x==="object"){args.push(x.name);args.push(x);good=true}if(good){last=args.length-1;args[last].parentState=name;args[last].globalConcurrentState=tree;that.addState.apply(that,args)}});return this},initStates:function(init){var x,state;this._inInitialSetup=true;if(typeof init==="string"){this.goToState(init,Stativus.DEFAULT_TREE)}else if(typeof init==="object"){for(x in init){if(init.hasOwnProperty(x)){state=init[x];this.goToState(state,x)}}}this._inInitialSetup=false;this._flushPendingEvents();return this},goToState:function(requestedStateName,tree,localConcurrentState,data){var cState,allStates=this._all_states[tree],idx,len,enterStates=[],exitStates=[],haveExited,enterMatchIndex,exitMatchIndex,that,reqState,pState,i,substateTree,enterStateHandled,exitStateHandled,substates;cState=localConcurrentState?this._current_state[localConcurrentState]:this._current_state[tree];reqState=allStates[requestedStateName];if(this._checkAllCurrentStates(reqState,localConcurrentState||tree))return;this._setDataOnState(reqState,data);if(this._goToStateLocked){this._pendingStateTransitions.push({requestedState:requestedStateName,tree:tree});return}this._goToStateLocked=true;enterStates=this._parentStatesWithRoot(reqState);exitStates=cState?this._parentStatesWithRoot(cState):[];enterMatchIndex=-1;for(idx=0,len=exitStates.length;idx<len;idx++){exitMatchIndex=idx;enterMatchIndex=enterStates.indexOf(exitStates[idx]);if(enterMatchIndex>=0)break}if(enterMatchIndex<0)enterMatchIndex=enterStates.length-1;this._enterStates=enterStates;this._enterStateMatchIndex=enterMatchIndex;this._enterStateConcurrentTree=localConcurrentState;this._enterStateTree=tree;this._exitStateStack=[];if(cState&&cState.substatesAreConcurrent)this._fullExitFromSubstates(tree,cState);for(i=0;i<exitMatchIndex;i+=1){cState=exitStates[i];this._exitStateStack.push(cState)}this._unwindExitStateStack()},goToHistoryState:function(requestedState,tree,localConcurrentState,isRecursive){var allStatesForTree=this._all_states[tree],pState,realHistoryState;pState=allStatesForTree[requestedState];if(pState)realHistoryState=pState.history||pState.initialSubstate;if(!realHistoryState){realHistoryState=requestedState}else if(isRecursive){this.goToHistoryState(realHistoryState,tree,isRecursive);return}this.goToState(realHistoryState,tree)},currentState:function(tree){var ret,tmp,sTree,aTrees,bTree,cStates=this._current_state,cState,i,len,state,ps,aStates;tree=tree||"default";cState=cStates[tree];aStates=this._all_states[tree];if(cState&&cState.isState){ret=this._parentStates(cState)}if(cState&&cState.substatesAreConcurrent){aTrees=this._active_subtrees[tree]||[];for(i=0,len=aTrees.length;i<len;i++){sTree=aTrees[i];state=cStates[sTree];if(state)ps=aStates[state.parentState];if(ps&&ret.indexOf(ps)<0)ret.unshift(ps);if(state&&ret.indexOf(state)<0)ret.unshift(state)}}return ret},sendEvent:function(evt){var args=[],len=arguments.length,i;if(len<1)return;for(i=1;i<len;i++){args[i-1]=arguments[i]}try{if(this._inInitialSetup||this._sendEventLocked||this._goToStateLocked){this._pendingEvents.push({evt:evt,args:args});return}this._sendEventLocked=true;this._processEvent(evt,args)}catch(err){this._restartEvents();throw err}this._restartEvents()},_setDataOnState:function(state,data){if(state&&typeof data!=="undefined"&&data!==null){if(typeof data==="string")state.setData(data,data);if(typeof data==="object"){for(var key in data){if(data.hasOwnProperty(key))state.setData(key,data[key])}}}},_processEvent:function(evt,args){this._structureCrawl("_cascadeEvents",evt,args)},getData:function(key,stateName,tree){var allStates=this._all_states[tree],state;if(!allStates)return null;state=allStates[stateName];if(state&&state.isState)return state.getData(key)},removeData:function(key,statename,tree){var allStates=this._all_states[tree],state;if(!allStates)return null;state=allStates[statename];if(state&&state.isState)return state.removeData(key)},getState:function(name,tree){var allStates,ret;tree=tree||Stativus.DEFAULT_TREE;allStates=this._all_states[tree];if(!allStates)return null;ret=allStates[name];return ret},_restartEvents:function(){this._sendEventLocked=false;if(!this._inInitialSetup)this._flushPendingEvents()},_structureCrawl:function(func,evt,args){var tree,currentStates=this._current_state,i,len,sResponder,tmp,allStates,responder,aTrees,sTree,handled,found,ss=Stativus.SUBSTATE_DELIM;for(tree in currentStates){if(!currentStates.hasOwnProperty(tree))continue;handled=false;sTree=null;responder=currentStates[tree];if(!responder||tree.slice(0,ss.length)===ss)continue;allStates=this._all_states[tree];if(!allStates)continue;aTrees=this._active_subtrees[tree]||[];for(i=0,len=aTrees.length;i<len;i++){sTree=aTrees[i];sResponder=currentStates[sTree];tmp=handled?[true,true]:this[func](evt,args,sResponder,allStates,sTree);handled=tmp[0]}if(!handled){tmp=this[func](evt,args,responder,allStates,null);handled=tmp[0]}}},_cascadeEvents:function(evt,args,responder,allStates,tree){var handled,trees,len,ssName,found=false;if(tree){trees=tree.split("=>");len=trees.length||0;ssName=trees[len-1]}while(!handled&&responder){if(responder[evt]){try{handled=responder[evt].apply(responder,args)}catch(e){}found=true}if(tree&&ssName===responder.name)return[handled,found];responder=!handled&&responder.parentState?allStates[responder.parentState]:null}return[handled,found]},_checkAllCurrentStates:function(reqState,tree){var currentStates=this.currentState(tree)||[];if(currentStates===reqState)return true;else if(typeof currentStates==="string"&&reqState===this._all_states[tree][currentStates])return true;else if(currentStates.indexOf&&currentStates.indexOf(reqState)>-1)return true;else return false},_flushPendingEvents:function(){var args,pa=this._pendingEvents.shift();if(!pa)return;args=pa.args;args.unshift(pa.evt);this.sendEvent.apply(this,args)},_flushPendingStateTransitions:function(){var pending=this._pendingStateTransitions.shift(),msg;if(!pending)return false;this.goToState(pending.requestedState,pending.tree);return true},_fullEnter:function(state){var pState,enterStateHandled=false;if(!state)return;try{if(state.enterState)state.enterState();if(state.didEnterState)state.didEnterState()}catch(e){}if(state.parentState){pState=state.statechart.getState(state.parentState,state.globalConcurrentState);pState.setHistoryState(state)}this._unwindEnterStateStack()},_fullExit:function(state){var pState;if(!state)return;var exitStateHandled=false;try{if(state.exitState)state.exitState();if(state.didExitState)state.didExitState()}catch(e){}this._unwindExitStateStack()},_initiateEnterStateSequence:function(){var enterStates,enterMatchIndex,concurrentTree,tree,allStates,i,cState;enterStates=this._enterStates;enterMatchIndex=this._enterStateMatchIndex;concurrentTree=this._enterStateConcurrentTree;tree=this._enterStateTree;allStates=this._all_states[tree];this._enterStateStack=this._enterStateStack||[];i=enterMatchIndex-1;cState=enterStates[i];if(cState)this._cascadeEnterSubstates(cState,enterStates,i-1,concurrentTree||tree,allStates);this._unwindEnterStateStack();enterStates=null;enterMatchIndex=null;concurrentTree=null;tree=null;delete this._enterStates;delete this._enterStateMatchIndex;delete this._enterStateConcurrentTree;delete this._enterStateTree},_cascadeEnterSubstates:function(start,requiredStates,index,tree,allStates){var cState,len=requiredStates.length,pState,subStates,that=this,nTree,bTree,name,currStates,aTrees,nTreeBase;if(!start)return;name=start.name;this._enterStateStack.push(start);this._current_state[tree]=start;start.localConcurrentState=tree;if(start.substatesAreConcurrent){tree=start.globalConcurrentState||Stativus.DEFAULT_TREE;nTreeBase=[Stativus.SUBSTATE_DELIM,tree,name].join("=>");subStates=start.substates||[];subStates.forEach(function(x){nTree=nTreeBase+"=>"+x;cState=allStates[x];bTree=cState.globalConcurrentState||Stativus.DEFAULT_TREE;aTrees=that._active_subtrees[bTree]||[];aTrees.unshift(nTree);that._active_subtrees[bTree]=aTrees;if(index>-1&&requiredStates[index]===cState)index-=1;that._cascadeEnterSubstates(cState,requiredStates,index,nTree,allStates)});return}else{cState=requiredStates[index];if(cState){if(index>-1&&requiredStates[index]===cState)index-=1;this._cascadeEnterSubstates(cState,requiredStates,index,tree,allStates)}else{cState=allStates[start.initialSubstate];this._cascadeEnterSubstates(cState,requiredStates,index,tree,allStates)}}},_fullExitFromSubstates:function(tree,stopState){var cStates,allStates,func,that=this;if(!tree||!stopState||!tree||!stopState.substates)return;allStates=this._all_states[tree];cStates=this._current_state;this._exitStateStack=this._exitStateStack||[];stopState.substates.forEach(function(state){var substateTree,currState,curr,exitStateHandled,aTrees;substateTree=[Stativus.SUBSTATE_DELIM,tree,stopState.name,state].join("=>");currState=cStates[substateTree];while(currState&&currState!==stopState){exitStateHandled=false;if(!currState)continue;that._exitStateStack.unshift(currState);if(currState.substatesAreConcurrent)that._fullExitFromSubstates(tree,currState);curr=currState.parentState;currState=allStates[curr]}that._active_subtrees[tree]=that._removeFromActiveTree(tree,substateTree)})},_unwindExitStateStack:function(){var stateToExit,delayForAsync=false,stateRestart,sc=this;this._exitStateStack=this._exitStateStack||[];stateToExit=this._exitStateStack.shift();if(stateToExit){if(stateToExit.willExitState){stateRestart=function(){var sc=this._statechart;if(sc)sc._fullExit(stateToExit)};delayForAsync=stateToExit.willExitState(stateRestart)}if(!delayForAsync)this._fullExit(stateToExit)}else{delete this._exitStateStack;this._initiateEnterStateSequence()}},_unwindEnterStateStack:function(){var stateToEnter,delayForAsync=false,stateRestart,more,that=this;this._exitStateStack=this._exitStateStack||[];stateToEnter=this._enterStateStack.shift();if(stateToEnter){if(stateToEnter.willEnterState){stateRestart=function(){if(that)that._fullEnter(stateToEnter)};delayForAsync=stateToEnter.willEnterState(stateRestart)}if(!delayForAsync)this._fullEnter(stateToEnter)}else{delete this._enterStateStack;this._goToStateLocked=false;more=this._flushPendingStateTransitions();if(!more&&!this._inInitialSetup){this._flushPendingEvents()}}},_removeFromActiveTree:function(baseTree,tree){var nArray=[],aTrees=this._active_subtrees[baseTree];if(!aTrees)return[];if(!tree)return aTrees;aTrees.forEach(function(x){if(x!==tree)nArray.push(x)});return nArray},_parentStateObject:function(name,tree){if(name&&tree&&this._all_states[tree]){return this._all_states[tree][name]}},_parentStates:function(state){var ret=[],curr=state;ret.push(curr);curr=this._parentStateObject(curr.parentState,curr.globalConcurrentState);while(curr){ret.push(curr);curr=this._parentStateObject(curr.parentState,curr.globalConcurrentState)}return ret},_parentStatesWithRoot:function(state){var ret=this._parentStates(state);ret.push("root");return ret}};Stativus.createStatechart=function(){return this.Statechart.create()};if(EVENTABLE){Stativus.Statechart._internalTryToPerform=function(node,evt,args){var that=this,lookup,selectors;if(!node||!node.className)return;selectors=node.className.split(/\s+/).map(function(x){return"."+x});if(node.id)selectors.push("#"+node.id);selectors.forEach(function(x){lookup=(x+" "+evt).replace(/^\s\s*/,"").replace(/\s\s*$/,"");that._structureCrawl("_cascadeActionHandler",lookup,args)})};Stativus.Statechart._cascadeActionHandler=function(lookup,args,responder,allStates,tree){var handled,trees,len,ssName,found=false,evt;if(tree){trees=tree.split("=>");len=trees.length||0;ssName=trees[len-1]}while(!handled&&responder){evt=responder.actions?responder.actions[lookup]:null;if(evt){args.unshift(evt);this.sendEvent.apply(this,args);return[true,true]}if(tree&&ssName===responder.name)return[handled,found];responder=!handled&&responder.parentState?allStates[responder.parentState]:null}return[handled,found]};var jQueryIsLoaded=false;try{if(jQuery)jQueryIsLoaded=true}catch(err){jQueryIsLoaded=false}if(jQueryIsLoaded){var findEventableNodeData=function(start){var parents,evt,evts,args,node=$(start),found,ret;if(node.hasClass("eventable"))found=node;if(!found){parents=node.parents(".eventable");if(parents&&parents.length>0)found=parents}if(found){args=found.attr("data");args=args?args.split("::"):[];found=found[0]}return[found,args]};Stativus.Statechart.tryToPerform=function(evt){if(!evt)return;var args,selectors=[],tuple=findEventableNodeData(evt.target);if(!tuple[0])return;tuple[1].push(evt);this._internalTryToPerform(tuple[0],evt.type,tuple[1])}}else{Stativus.Statechart.tryToPerform=function(evt){if(!evt)return;var args=[],len=arguments.length,i,lookup;if(len<2)return;for(i=2;i<len;i++){args[i-2]=arguments[i]}args.push(evt);this._internalTryToPerform(evt.target,evt.type,args)}}}if(typeof window!=="undefined"){window.Stativus=Stativus}else if(typeof exports!=="undefined"){module.exports=Stativus}